<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OPEN ME</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Courier New', 'Courier', monospace;
            touch-action: manipulation;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }

        .game-container {
            width: 100%;
            max-width: 390px;
            height: 100vh;
            max-height: 844px;
            position: relative;
            overflow: hidden;
            background: #000;
            margin: 0 auto;
        }

        /* Видео только под первой сценой */
        .background-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
            opacity: 1;
            filter: none;
            pointer-events: none;
        }

        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: all 0.5s ease;
            z-index: 1;
        }

        #page1 {
            opacity: 1;
            z-index: 2;
        }

        #page1.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #page2 {
            opacity: 0;
            z-index: 1;
            pointer-events: none;
            background: #000;
        }

        #page2.visible {
            opacity: 1;
            z-index: 3;
            pointer-events: auto;
        }

        .crt-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 9998;
            pointer-events: none;
            opacity: 0;
        }

        .crt-effect.active {
            animation: crtShutdown 0.5s forwards;
        }

        @keyframes crtShutdown {
            0% { opacity: 0; transform: scale(1); }
            10% { opacity: 0.8; transform: scale(0.98); }
            20% { opacity: 1; transform: scale(0.95); }
            30% { opacity: 0.9; transform: scale(0.9) skewX(2deg); }
            40% { opacity: 1; transform: scale(0.85) skewX(-2deg); }
            50% { opacity: 0.7; transform: scale(0.8) skewX(3deg); filter: brightness(2); }
            60% { opacity: 0.9; transform: scale(0.7); filter: brightness(1); }
            70% { opacity: 0.5; transform: scale(0.5) skewX(-5deg); }
            80% { opacity: 0.8; transform: scale(0.3); filter: brightness(0.5); }
            90% { opacity: 0.3; transform: scale(0.1); }
            100% { opacity: 0; transform: scale(0); }
        }

        /* Крестик на сцене 1 – голый, без фона, прозрачность 0.4, смещён */
        .skip-cross {
            position: absolute;
            top: 80px;          /* опущен на ~20px от исходного 60px */
            right: 15px;         /* сдвинут влево на 5px от исходного 20px */
            color: rgba(255, 255, 255, 0.4); /* прозрачность 40% */
            font-family: 'Arial', sans-serif;
            font-size: 36px;
            font-weight: 300;
            cursor: pointer;
            z-index: 2147483647;
            user-select: none;
            line-height: 1;
            transition: opacity 0.2s ease;
            pointer-events: auto;
        }

        .skip-cross:hover,
        .skip-cross:active {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Крестик на сцене 2 */
        .skip-cross2 {
            position: absolute;
            top: 80px;
            right: 15px;
            color: rgba(255, 255, 255, 0.4);
            font-family: 'Arial', sans-serif;
            font-size: 36px;
            font-weight: 300;
            cursor: pointer;
            z-index: 2147483647;
            user-select: none;
            line-height: 1;
            transition: opacity 0.2s ease;
            pointer-events: auto;
        }

        .skip-cross2:hover,
        .skip-cross2:active {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Сцена 1: голова на видео */
        .fashion-page {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            background: transparent;
        }

        #canvas-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 100;
            pointer-events: auto;
        }

        /* ===== СЦЕНА 2: ХОРРОР ===== */
        .horror-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: #000;
        }

        #characterImage {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            position: relative;
            z-index: 1;
        }

        .vignette {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, 
                        transparent 40%, 
                        rgba(0, 0, 0, 0.5) 100%);
            pointer-events: none;
            z-index: 2;
        }

        .subtitles-container {
            position: absolute;
            bottom: 180px;
            left: 0;
            width: 100%;
            padding: 0 25px;
            z-index: 20;
            display: flex;
            justify-content: center;
            pointer-events: none;
        }

        .subtitles {
            color: #f0e68c;
            font-family: 'Courier New', 'Courier', monospace;
            font-size: 18px;
            line-height: 1.6;
            text-align: center;
            text-shadow: 2px 2px 0px #000;
            letter-spacing: 1px;
            max-width: 100%;
            width: 100%;
            opacity: 0;
            transition: opacity 0.15s ease;
            text-transform: uppercase;
        }

        .subtitles.visible {
            opacity: 1;
        }

        .bottom-area {
            position: absolute;
            bottom: 70px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            z-index: 30;
            pointer-events: none;
        }

        .action-button {
            background: rgba(255, 255, 255, 0.18);
            border: 1px solid rgba(255, 255, 240, 0.25);
            color: rgba(255, 255, 240, 0.9);
            font-family: 'Courier New', 'Courier', monospace;
            font-size: 22px;
            letter-spacing: 3px;
            padding: 12px 40px;
            cursor: pointer;
            pointer-events: auto;
            backdrop-filter: blur(2px);
            transition: all 0.2s ease;
            text-transform: lowercase;
            min-width: 180px;
            text-align: center;
            position: relative;
            z-index: 31;
        }

        .action-button.playing {
            background: rgba(255, 255, 200, 0.2);
            border: 1px solid rgba(255, 255, 200, 0.4);
        }
    </style>
</head>
<body>
    <div class="crt-effect" id="crtEffect"></div>

    <div class="game-container">
        <video class="background-video" id="bgVideo" autoplay loop muted playsinline>
            <source src="fashion-bg.mp4" type="video/mp4">
        </video>

        <!-- СЦЕНА 1: ПРАЗДНИК -->
        <div class="page" id="page1">
            <div class="skip-cross" id="skipButton">✕</div>
            <div class="fashion-page">
                <div id="canvas-container"></div>
            </div>
        </div>

        <!-- СЦЕНА 2: ХОРРОР -->
        <div class="page" id="page2">
            <div class="skip-cross2" id="skipButton2">✕</div>
            <div class="horror-container">
                <img src="mouth-closed.png" alt="" id="characterImage">
                <div class="vignette"></div>
            </div>
            <div class="subtitles-container">
                <div class="subtitles" id="subtitles"></div>
            </div>
            <div class="bottom-area">
                <button class="action-button" id="actionButton">hello</button>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.128.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.128.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        class BirthdayParty {
            constructor() {
                console.log('Конструктор запущен');
                
                // Элементы сцены 1
                this.skipButton = document.getElementById('skipButton');
                this.bgVideo = document.getElementById('bgVideo');
                
                // Элементы сцены 2
                this.image = document.getElementById('characterImage');
                this.button = document.getElementById('actionButton');
                this.subtitles = document.getElementById('subtitles');
                this.skipButton2 = document.getElementById('skipButton2');
                
                // Страницы
                this.page1 = document.getElementById('page1');
                this.page2 = document.getElementById('page2');
                this.crtEffect = document.getElementById('crtEffect');
                
                // Музыка для первой сцены
                this.bgMusic = new Audio();
                this.bgMusic.loop = true;
                this.bgMusic.volume = 0.5;
                this.isMusicPlaying = false;
                this.bgMusic.src = 'birthday-music.mp3';
                
                // Аудио для второй сцены
                this.audioFiles = {
                    hello: 'voice1.mp3',
                    thanks: 'voice2.mp3'
                };
                
                // Субтитры для второй записи
                this.subtitleParts = [
                    { text: "Соединение прервано.", start: 0, end: 2.5 },
                    { text: "Мне жаль, что я прерываю вас, Мелина,", start: 2.5, end: 5.5 },
                    { text: "если вы еще помните это имя,", start: 5.5, end: 8 },
                    { text: "но боюсь, вас дезинформировали.", start: 8, end: 10.5 },
                    { text: "Вы здесь не для того,", start: 10.5, end: 12.5 },
                    { text: "чтобы получить подарок,", start: 12.5, end: 14.5 },
                    { text: "и вас не позвал сюда человек,", start: 14.5, end: 17 },
                    { text: "которого вы предполагаете,", start: 17, end: 19 },
                    { text: "хотя вас действительно позвали.", start: 19, end: 21.5 },
                    { text: "Вы все были вызваны сюда,", start: 21.5, end: 24 },
                    { text: "в лабиринт звуков и запахов,", start: 24, end: 26.5 },
                    { text: "дезинформации и несчастий.", start: 26.5, end: 29 },
                    { text: "Лабиринт без выхода,", start: 29, end: 31 },
                    { text: "лабиринт без приза.", start: 31, end: 33 },
                    { text: "Вы даже не понимаете,", start: 33, end: 35 },
                    { text: "что попали в ловушку.", start: 35, end: 37 },
                    { text: "Ваша жажда крови", start: 37, end: 39 },
                    { text: "загнала вас в бесконечные круги,", start: 39, end: 42 },
                    { text: "преследуя крики детей", start: 42, end: 44 },
                    { text: "в какой-то невидимой комнате,", start: 44, end: 46.5 },
                    { text: "всегда кажущейся такой близкой,", start: 46.5, end: 49 },
                    { text: "но почему-то недостижимой,", start: 49, end: 51.5 },
                    { text: "но вы никогда их не найдете.", start: 51.5, end: 54.5 },
                    { text: "Никто из вас не найдет.", start: 54.5, end: 57 },
                    { text: "Здесь ваша история заканчивается.", start: 57, end: 60 }
                ];
                
                this.currentState = 'hello';
                this.isPlaying = false;
                this.audio = new Audio();
                this.animationInterval = null;
                this.subtitleInterval = null;
                this.currentSubtitleIndex = -1;
                this.transitionDirection = 'toHorror';
                
                // 3D переменные
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.model = null;
                this.clock = new THREE.Clock();
                this.originalScale = 1;
                this.isAnimating = false;
                
                this.targetRotationSpeed = 0.0038;
                this.currentRotationSpeed = 0;
                this.rotationAnimation = null;
                
                this.raycaster = new THREE.Raycaster();
                this.mouse = new THREE.Vector2();
                
                this.init();
            }
            
            init() {
                console.log('Инициализация...');
                
                if (this.skipButton) {
                    this.skipButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Крестик сцены 1 нажат');
                        this.transitionDirection = 'toHorror';
                        this.playTransition();
                    });
                }
                
                if (this.skipButton2) {
                    this.skipButton2.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Крестик сцены 2 нажат');
                        this.transitionDirection = 'toParty';
                        this.playTransition();
                    });
                }
                
                if (this.button) {
                    this.button.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Кнопка в хорроре нажата');
                        this.onButtonClick();
                    });
                }
                
                this.audio.addEventListener('ended', () => this.onEnded());
                this.audio.addEventListener('error', (e) => this.onError(e));
                
                setTimeout(() => {
                    this.init3D();
                }, 100);
            }
            
            // Плавное изменение скорости вращения
            animateRotationSpeed(targetSpeed) {
                if (this.rotationAnimation) {
                    cancelAnimationFrame(this.rotationAnimation);
                }
                
                const startSpeed = this.currentRotationSpeed;
                const startTime = performance.now();
                const duration = 500;
                
                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    this.currentRotationSpeed = startSpeed + (targetSpeed - startSpeed) * (1 - Math.pow(1 - progress, 3));
                    
                    if (progress < 1) {
                        this.rotationAnimation = requestAnimationFrame(animate);
                    } else {
                        this.currentRotationSpeed = targetSpeed;
                        this.rotationAnimation = null;
                    }
                };
                
                this.rotationAnimation = requestAnimationFrame(animate);
            }
            
            // Включение/выключение музыки и вращения по клику на голову
            toggleMusicAndRotation() {
                if (!this.model) return;
                
                if (this.isMusicPlaying) {
                    this.bgMusic.pause();
                    this.isMusicPlaying = false;
                    this.animateRotationSpeed(0);
                    this.animateHeadClick();
                    console.log('Музыка остановлена');
                } else {
                    this.bgMusic.play()
                        .then(() => {
                            this.isMusicPlaying = true;
                            this.animateRotationSpeed(0.0038);
                            this.animateHeadClick();
                            console.log('Музыка играет');
                        })
                        .catch(e => {
                            console.log('Не удалось включить музыку:', e);
                        });
                }
            }
            
            // Анимация пульсации при клике (плавное возвращение)
            animateHeadClick() {
                if (this.isAnimating || !this.model) return;
                
                this.isAnimating = true;
                
                const originalScale = this.model.scale.x;
                let progress = 0;
                const duration = 400;
                const startTime = performance.now();
                
                const currentY = this.model.position.y; // запоминаем текущую Y
                
                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    progress = Math.min(elapsed / duration, 1);
                    
                    if (progress < 0.5) {
                        const t = progress * 2;
                        const scale = originalScale * (1 + t * 0.08);
                        this.model.scale.set(scale, scale, scale);
                    } else {
                        const t = (progress - 0.5) * 2;
                        const scale = originalScale * (1.08 - t * 0.08);
                        this.model.scale.set(scale, scale, scale);
                    }
                    
                    // Удерживаем позицию Y, чтобы не было рывка
                    this.model.position.y = currentY;
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        this.model.scale.set(originalScale, originalScale, originalScale);
                        this.isAnimating = false;
                    }
                };
                
                requestAnimationFrame(animate);
            }
            
            // Обработчик клика по 3D-модели
            onCanvasClick(event) {
                if (!this.model || this.isAnimating) return;
                
                const rect = this.renderer.domElement.getBoundingClientRect();
                
                this.mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                this.mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                
                this.raycaster.setFromCamera(this.mouse, this.camera);
                
                const intersects = this.raycaster.intersectObject(this.model, true);
                
                if (intersects.length > 0) {
                    this.toggleMusicAndRotation();
                }
            }
            
            // ===== ВТОРАЯ СЦЕНА =====
            onButtonClick() {
                console.log('Кнопка в хорроре, состояние:', this.currentState);
                if (this.isPlaying) {
                    console.log('Уже играет');
                    return;
                }
                this.startPlayback();
            }
            
            startPlayback() {
                console.log('Старт воспроизведения');
                this.isPlaying = true;
                if (this.button) this.button.classList.add('playing');
                
                this.startMouthAnimation();
                
                if (this.currentState === 'thanks') {
                    this.startSubtitles();
                }
                
                const audioFile = this.audioFiles[this.currentState];
                console.log('Загружаем аудио:', audioFile);
                
                this.audio.src = audioFile;
                this.audio.play()
                    .then(() => console.log('Аудио играет'))
                    .catch(e => {
                        console.error('Ошибка воспроизведения:', e);
                        alert(`Файл ${audioFile} не найден! Проверьте название файла.`);
                        this.stopPlayback();
                    });
            }
            
            startSubtitles() {
                if (!this.subtitles) return;
                this.subtitles.classList.add('visible');
                this.currentSubtitleIndex = -1;
                
                this.subtitleInterval = setInterval(() => {
                    if (!this.isPlaying || !this.audio) return;
                    
                    const currentTime = this.audio.currentTime;
                    
                    for (let i = 0; i < this.subtitleParts.length; i++) {
                        if (currentTime >= this.subtitleParts[i].start && 
                            currentTime < this.subtitleParts[i].end) {
                            
                            if (i !== this.currentSubtitleIndex) {
                                this.currentSubtitleIndex = i;
                                this.subtitles.textContent = this.subtitleParts[i].text;
                            }
                            break;
                        }
                    }
                }, 100);
            }
            
            startMouthAnimation() {
                let isOpen = false;
                
                this.animationInterval = setInterval(() => {
                    if (!this.isPlaying) return;
                    isOpen = !isOpen;
                    if (this.image) {
                        this.image.src = isOpen ? 'mouth-open.png' : 'mouth-closed.png';
                    }
                }, 200);
            }
            
            stopMouthAnimation() {
                if (this.animationInterval) {
                    clearInterval(this.animationInterval);
                    this.animationInterval = null;
                }
                if (this.image) {
                    this.image.src = 'mouth-closed.png';
                }
            }
            
            stopSubtitles() {
                if (this.subtitleInterval) {
                    clearInterval(this.subtitleInterval);
                    this.subtitleInterval = null;
                }
                if (this.subtitles) {
                    this.subtitles.classList.remove('visible');
                    this.subtitles.textContent = '';
                }
                this.currentSubtitleIndex = -1;
            }
            
            // Сброс второй сцены в исходное состояние (при возврате на первую сцену)
            resetScene2() {
                // Останавливаем аудио, если играет
                if (this.isPlaying) {
                    this.audio.pause();
                    this.audio.currentTime = 0;
                    this.stopMouthAnimation();
                    this.stopSubtitles();
                    if (this.button) this.button.classList.remove('playing');
                    this.isPlaying = false;
                }
                // Возвращаем кнопку в состояние hello
                if (this.currentState !== 'hello') {
                    this.currentState = 'hello';
                    if (this.button) this.button.textContent = 'hello';
                }
                // Убеждаемся, что картинка с закрытым ртом
                if (this.image) {
                    this.image.src = 'mouth-closed.png';
                }
            }
            
            onEnded() {
                console.log('Воспроизведение закончено');
                this.stopMouthAnimation();
                this.stopSubtitles();
                
                if (this.currentState === 'hello') {
                    this.currentState = 'thanks';
                    if (this.button) this.button.textContent = 'thanks';
                } else {
                    this.currentState = 'hello';
                    if (this.button) this.button.textContent = 'hello';
                }
                
                if (this.button) this.button.classList.remove('playing');
                this.isPlaying = false;
            }
            
            onError(e) {
                console.error('Ошибка аудио:', e);
                this.stopMouthAnimation();
                this.stopSubtitles();
                if (this.button) this.button.classList.remove('playing');
                this.isPlaying = false;
            }
            
            stopPlayback() {
                if (this.audio) {
                    this.audio.pause();
                    this.audio.currentTime = 0;
                }
                this.stopMouthAnimation();
                this.stopSubtitles();
                if (this.button) this.button.classList.remove('playing');
                this.isPlaying = false;
            }
            
            // ===== 3D ИНИЦИАЛИЗАЦИЯ =====
            init3D() {
                console.log('Инициализация 3D');
                const container = document.getElementById('canvas-container');
                
                if (!container) {
                    console.error('Canvas container не найден!');
                    return;
                }
                
                this.scene = new THREE.Scene();
                const axesHelper = new THREE.AxesHelper(5);
this.scene.add(axesHelper);
                this.scene.background = null;
                const originSphere = new THREE.Mesh(
    new THREE.SphereGeometry(0.1, 8),
    new THREE.MeshBasicMaterial({ color: 0xff0000 })
);
this.scene.add(originSphere);
                
                this.camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
                this.camera.position.set(0, 0, 12);
                
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(container.clientWidth, container.clientHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                this.renderer.setClearColor(0x000000, 0);
                
                this.renderer.domElement.style.position = 'absolute';
                this.renderer.domElement.style.top = '0';
                this.renderer.domElement.style.left = '0';
                this.renderer.domElement.style.zIndex = '100';
                this.renderer.domElement.style.pointerEvents = 'auto';
                
                container.appendChild(this.renderer.domElement);
                
                this.renderer.domElement.style.cursor = 'pointer';
                this.renderer.domElement.addEventListener('click', (e) => this.onCanvasClick(e));
                
                // Освещение
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.9);
                this.scene.add(ambientLight);
                
                const frontLight = new THREE.DirectionalLight(0xffffff, 1.2);
                frontLight.position.set(0, 2, 5);
                this.scene.add(frontLight);
                
                const backLight = new THREE.DirectionalLight(0xffffff, 0.6);
                backLight.position.set(0, 1, -5);
                this.scene.add(backLight);
                
                // Загрузка модели
                const loader = new GLTFLoader();
                
                loader.load(
                    'anime-head.glb',
                    (gltf) => {
                        console.log('Модель загружена!');
                        this.model = gltf.scene;
                        
                        const box = new THREE.Box3().setFromObject(this.model);
                        const center = box.getCenter(new THREE.Vector3());
                        this.model.position.sub(center);
                        
                        
                        const size = box.getSize(new THREE.Vector3());
                        const maxDim = Math.max(size.x, size.y, size.z);
                        
                        const scale = 9 / maxDim;
                        this.model.scale.set(scale, scale, scale);
                        this.originalScale = scale;

                        this.model.position.z += -15.0;
                        // Подняли на 0.9
                        this.model.position.y += 0.9;
                        
                        this.scene.add(this.model);
                        
                        console.log('Модель добавлена. Масштаб:', scale);
                    },
                    (xhr) => {},
                    (error) => {
                        console.error('Ошибка загрузки модели:', error);
                        this.createPlaceholderHead();
                    }
                );
                
                this.animate();
                
                window.addEventListener('resize', () => this.onWindowResize());
            }
            
            createPlaceholderHead() {
                console.log('Создаем заглушку');
                const geometry = new THREE.SphereGeometry(1, 32, 32);
                const material = new THREE.MeshStandardMaterial({ color: 0xffaaaa });
                const sphere = new THREE.Mesh(geometry, material);
                
                const eyeGeo = new THREE.SphereGeometry(0.2, 16, 16);
                const eyeMat = new THREE.MeshStandardMaterial({ color: 0x000000 });
                const eye1 = new THREE.Mesh(eyeGeo, eyeMat);
                eye1.position.set(-0.4, 0.3, 0.85);
                sphere.add(eye1);
                const eye2 = new THREE.Mesh(eyeGeo, eyeMat);
                eye2.position.set(0.4, 0.3, 0.85);
                sphere.add(eye2);
                
                const mouthGeo = new THREE.TorusGeometry(0.2, 0.05, 8, 24, Math.PI);
                const mouthMat = new THREE.MeshStandardMaterial({ color: 0xaa5555 });
                const mouth = new THREE.Mesh(mouthGeo, mouthMat);
                mouth.rotation.x = Math.PI / 2;
                mouth.rotation.z = Math.PI;
                mouth.position.set(0, -0.2, 0.85);
                sphere.add(mouth);
                
                sphere.scale.set(2.25, 2.25, 2.25);
                sphere.position.y = 0.9;
                
                this.model = sphere;
                this.scene.add(this.model);
                this.originalScale = 2.25;
            }
            
            animate() {
                requestAnimationFrame(() => this.animate());
                
                if (this.model && !this.isAnimating) {
                    this.model.rotation.y += this.currentRotationSpeed;
                    
                    const time = this.clock.getElapsedTime();
                    this.model.position.y = 0.9 + Math.sin(time * 1.5) * 0.15;
                }
                
                if (this.renderer && this.scene && this.camera) {
                    this.renderer.render(this.scene, this.camera);
                }
            }
            
            onWindowResize() {
                const container = document.getElementById('canvas-container');
                if (this.camera && this.renderer && container) {
                    this.camera.aspect = container.clientWidth / container.clientHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(container.clientWidth, container.clientHeight);
                }
            }
            
            // ===== ПЕРЕХОД МЕЖДУ СЦЕНАМИ =====
            playTransition() {
                console.log('Запуск перехода, направление:', this.transitionDirection);
                
                this.crtEffect.classList.add('active');
                
                // Останавливаем видео в любом случае
                if (this.bgVideo) {
                    this.bgVideo.pause();
                }
                
                setTimeout(() => {
                    if (this.transitionDirection === 'toHorror') {
                        console.log('Переключение на сцену 2');
                        this.page1.classList.add('hidden');
                        this.page2.classList.add('visible');
                        
                        // Принудительные стили
                        this.page2.style.opacity = '1';
                        this.page2.style.zIndex = '3';
                        this.page2.style.pointerEvents = 'auto';
                        
                        // Останавливаем музыку первой сцены, если играла
                        if (this.isMusicPlaying) {
                            this.bgMusic.pause();
                            this.isMusicPlaying = false;
                            this.animateRotationSpeed(0);
                        }
                    } else {
                        console.log('Возврат на сцену 1');
                        
                        // Сброс второй сцены (остановка аудио, анимаций, возврат к hello)
                        this.resetScene2();
                        
                        this.page2.classList.remove('visible');
                        this.page1.classList.remove('hidden');
                        
                        // Принудительные стили
                        this.page1.style.opacity = '1';
                        this.page1.style.zIndex = '2';
                        this.page1.style.pointerEvents = 'auto';
                        
                        this.page2.style.opacity = '0';
                        this.page2.style.zIndex = '1';
                        this.page2.style.pointerEvents = 'none';
                        
                        // Запускаем видео обратно
                        if (this.bgVideo) {
                            this.bgVideo.play().catch(e => console.log('Не удалось запустить видео'));
                        }
                    }
                }, 500);
                
                setTimeout(() => {
                    this.crtEffect.classList.remove('active');
                }, 1000);
            }
        }

        window.addEventListener('load', () => {
            console.log('Страница загружена');
            new BirthdayParty();
        });
    </script>
</body>
</html>
